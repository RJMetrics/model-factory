/*! model-factory - v0.0.0 - 2014-03-24
* https://github.com/RJMetrics/model-factory
* Copyright (c) 2014 ; Licensed Apache v2 */
angular.module("rjmetrics.model-factory",["ng","jmdobry.angular-cache"]),angular.module("rjmetrics.model-factory").directive("formSubmittee",["$parse","$exceptionHandler",function(a,b){return{priority:9e3,restrict:"A",require:["ngModel","^form"],link:function(c,d,e,f){var g,h,i,j;return j=f[0],g=f[1],j.$parsers.push(function(a){return a===j.$modelValue&&j.$setPristine(),j.$modelValue}),i=a(e.ngModel),h=c.$on("formSubmitter-submit-"+g.$name,function(){return j.$modelValue=j.$viewValue,i.assign(c,j.$viewValue),angular.forEach(j.$viewChangeListeners,function(a){var c;try{return a()}catch(d){return c=d,b(c)}})}),c.$on("$destroy",h)}}}]),angular.module("rjmetrics.model-factory").directive("formSubmitter",["$parse",function(a){return{restrict:"A",require:"form",link:function(b,c,d,e){var f;return f=a(d.formSubmitter),c.on("submit",function(){return b.$apply(function(){return b.$broadcast("formSubmitter-submit-"+e.$name),b.$eval(d.formSubmitter),e.$setPristine()})}),b.$on("$destroy",function(){return c.off("submit")})}}}]),angular.module("rjmetrics.model-factory").factory("modelFactory",["$q","$http","$angularCacheFactory",function(a,b,c){var d;return d={maxAge:6e5,recycleFreq:3e5,deleteOnExpire:"aggressive"},function(e,f){var g;return f=angular.extend({},d,f),g=function(){function d(a){angular.copy(a||{},this),l.get(""+this.id)||l.put(""+this.id,this)}var g,h,i,j,k,l,m,n,o;return k={},j=null,m=[],i=!1,f.onExpire=function(a,c){return l.put(a,c),k[+a]?void 0:k[+a]=b.get(e+a).then(function(b){return delete k[+a],o(b.data)},function(){return delete k[+a],n(c)})},l=c(e,f),h=function(a){var b;return b=new d(a),m.push(b),b},o=function(a){var b;return b=l.get(""+a.id),angular.equals(b,a)||angular.copy(a,b),_(m).contains(b)||m.push(b),b},g=function(a){return _(a).each(function(a){return l.get(""+a.id)?o(a):h(a)}),m},n=function(a){m.length>0&&m.splice(m.indexOf(a),1),l.remove(""+a.id)},d.url=e,d.get=function(c,d,e){var f,g,i;return null==d&&(d=!1),null==e&&(e={}),null!=k[c]?k[c]:(f=a.defer(),i=l.get(""+c),d||null==i?(k[c]=f.promise,g=angular.extend({},e,{method:"GET",url:this.url+c}),b(g).then(function(a){return f.resolve(null!=l.get(""+c)?o(a.data):h(a.data)),delete k[c]},function(a){return f.reject(a),delete k[c]})):f.resolve(i),f.promise)},d.getCollection=function(c,d){var e,f;return null==c&&(c=!1),null==d&&(d={}),null!=j?j:(e=a.defer(),!c&&i?e.resolve(m):(i=!0,j=e.promise,f=angular.extend({},d,{method:"GET",url:this.url}),b(f).then(function(a){return e.resolve(g(a.data)),j=null},function(a){return e.reject(a),j=null})),e.promise)},d.save=function(a,c){var d;if(null==c&&(c={}),null==a.id)throw new Error("Model must have an id property to be saved");return d=angular.extend({},c,{method:"POST",url:this.url+a.id,data:a}),b(d).then(function(a){return o(a.data)},function(a){return a})},d.create=function(a,c){var d;if(null==c&&(c={}),null!=a.id)throw new Error("Can not create new model that already has an id set");return d=angular.extend({},c,{method:"POST",url:this.url,data:a}),b(d).then(function(a){return h(a.data)},function(a){return a})},d["delete"]=function(a,c){var d;return null==c&&(c={}),d=angular.extend({},c,{method:"DELETE",url:this.url+a.id}),b(d).then(function(b){return n(a),b},function(a){return a})},d.prototype.$get=function(a,b){return null==a&&(a=!1),null==b&&(b={}),d.get(this.id,a,b)},d.prototype.$save=function(a){return null==a&&(a={}),d.save(this,a)},d.prototype.$delete=function(a){return null==a&&(a={}),d["delete"](this,a)},d}()}}]);