/*! model-factory - v0.1.0 - 2014-09-10
* https://github.com/RJMetrics/model-factory
* Copyright (c) 2014 ; Licensed Apache v2 */
var __bind=function(a,b){return function(){return a.apply(b,arguments)}};angular.module("rjmetrics.model-factory",["ng","jmdobry.angular-cache"]),angular.module("rjmetrics.model-factory").directive("formSubmittee",["$parse","$exceptionHandler",function(a,b){return{priority:9e3,restrict:"A",require:["ngModel","^form"],link:function(c,d,e,f){var g,h,i,j;return j=f[0],g=f[1],j.$parsers.push(function(a){return a===j.$modelValue&&j.$setPristine(),j.$modelValue}),i=a(e.ngModel),h=c.$on("formSubmitter-submit-"+g.$name,function(){return j.$modelValue=j.$viewValue,i.assign(c,j.$viewValue),angular.forEach(j.$viewChangeListeners,function(a){var c;try{return a()}catch(d){return c=d,b(c)}})}),c.$on("$destroy",h)}}}]),angular.module("rjmetrics.model-factory").directive("formSubmitter",["$parse",function(a){return{restrict:"A",require:"form",link:function(b,c,d,e){var f;return f=a(d.formSubmitter),c.on("submit",function(){return b.$apply(function(){return b.$broadcast("formSubmitter-submit-"+e.$name),b.$eval(d.formSubmitter),e.$setPristine()})}),b.$on("$destroy",function(){return c.off("submit")})}}}]),angular.module("rjmetrics.model-factory").factory("modelFactory",["$q","$http","$angularCacheFactory",function(a,b,c){var d,e;return d={maxAge:6e5,recycleFreq:3e5,deleteOnExpire:"aggressive"},e={},function(f,g){var h,i;return null==g&&(g={}),i=angular.extend({},d,g.cacheOptions),h=function(){function d(a){this.$delete=__bind(this.$delete,this),this.$save=__bind(this.$save,this),this.$get=__bind(this.$get,this),angular.copy(a||{},this),o.get(""+this.id)||o.put(""+this.id,this)}var h,j,k,l,m,n,o,p,q,r,s,t;return d.httpConfig=angular.extend({},g.httpConfig,e),n={},m=null,r={},p=[],l=!1,q={},i.onExpire=function(a,c){var d;return o.put(a,c),n[+a]?void 0:(d=angular.extend({},this.httpConfig,{method:"GET",url:""+f+"/"+a}),n[+a]=b(d).then(function(b){return delete n[+a],t(b.data)},function(){return delete n[+a],s(c)}))},o=c(f,i),j=function(a){var b;return b=new d(a),p.push(b),b},t=function(a){var b;return b=o.get(""+a.id),angular.equals(b,a)||angular.copy(a,b),_(p).contains(b)||p.push(b),b},h=function(a){return _(a).each(function(a){return o.get(""+a.id)?t(a):j(a)}),p},k=function(a,b){var c,d,e,f;if(d=_(b).map(function(a){return o.get(""+a.id)?t(a):j(a)}),null!=q[a])for(q[a].length=0,e=0,f=d.length;f>e;e++)c=d[e],q[a].push(c);else q[a]=d;return q[a]},s=function(a){var b,c,d,e;for(p.length>0&&p.splice(p.indexOf(a),1),b=d=0,e=q.length;e>d;b=++d)c=q[b],b.length>0&&b.splice(b.indexOf(a),1);o.remove(""+a.id)},d.url=f,d.get=function(c,e,f){var g,h,i;return null==e&&(e=!1),null==f&&(f={}),null!=n[c]?n[c]:(g=a.defer(),i=o.get(""+c),e||null==i?(n[c]=g.promise,h=angular.extend({},d.httpConfig,f,{method:"GET",url:d.url+"/"+c}),b(h).then(function(a){return g.resolve(null!=o.get(""+c)?t(a.data):j(a.data)),delete n[c]},function(a){return g.reject(a),delete n[c]})):g.resolve(i),g.promise)},d.query=function(c,e,f){var g,h,i,j,l;return null==c&&(c={}),null==e&&(e=!1),null==f&&(f={}),l=Object.keys(c).sort(),j=_(l).map(function(a){return""+a+"="+c[a]}),i=j.join("&"),null!=r[i]?r[i]:(g=a.defer(),e||null==q[i]?(r[i]=g.promise,h=angular.extend({},d.httpConfig,f,{method:"GET",url:d.url,params:c}),b(h).then(function(a){var b;return b=k(i,a.data),g.resolve(b),delete r[i]},function(a){return g.reject(a),delete r[i]})):g.resolve(q[i]),g.promise)},d.getCollection=function(c,e){var f,g;return null==c&&(c=!1),null==e&&(e={}),null!=m?m:(f=a.defer(),!c&&l?f.resolve(p):(l=!0,m=f.promise,g=angular.extend({},d.httpConfig,e,{method:"GET",url:d.url}),b(g).then(function(a){return f.resolve(h(a.data)),m=null},function(a){return f.reject(a),m=null})),f.promise)},d.save=function(c,d){var e;if(null==d&&(d={}),null==c.id)throw new Error("Model must have an id property to be saved");return e=angular.extend({},this.httpConfig,d,{method:g.postSave?"POST":"PUT",url:this.url+"/"+c.id,data:c}),b(e).then(function(a){return t(a.data)},function(b){return a.reject(b)})},d.create=function(c,e){var f;if(null==e&&(e={}),null!=c.id)throw new Error("Can not create new model that already has an id set");return f=angular.extend({},d.httpConfig,e,{method:"POST",url:d.url,data:c}),b(f).then(function(a){return j(a.data)},function(b){return a.reject(b)})},d["delete"]=function(c,e){var f;return null==e&&(e={}),f=angular.extend({},d.httpConfig,e,{method:"DELETE",url:d.url+"/"+c.id}),b(f).then(function(a){return s(c),a},function(b){return a.reject(b)})},d.prototype.$get=function(a,b){return null==a&&(a=!1),null==b&&(b={}),d.get(this.id,a,b)},d.prototype.$save=function(a){return null==a&&(a={}),d.save(this,a)},d.prototype.$delete=function(a){return null==a&&(a={}),d["delete"](this,a)},d}()}}]);